name: Intelligent AWS Bootstrap
on:
  push:
    branches: [ "main" ]

jobs:
  infrastructure-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials (OIDC Test)
        id: aws-login
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Check ECR for Existing Image
        id: check-ecr
        run: |
          # 1. Check if ECR Repo exists. If not, we need to run TF for ECR first.
          REPO_EXISTS=$(aws ecr describe-repositories --repository-names app-repo 2>&1 || true)
          
          if [[ $REPO_EXISTS == *"RepositoryNotFoundException"* ]]; then
            echo "setup_state=no_repo" >> $GITHUB_OUTPUT
          else
            # 2. Check if there is at least one image
            IMAGE_COUNT=$(aws ecr list-images --repository-name app-repo --query 'imageIds' --output json | jq '. | length')
            if [ "$IMAGE_COUNT" -eq "0" ]; then
              echo "setup_state=repo_empty" >> $GITHUB_OUTPUT
            else
              echo "setup_state=ready" >> $GITHUB_OUTPUT
            fi
          fi

      # STEP A: If no repo exists, run Terraform just for the ECR/Networking
      - name: Terraform Apply (Initial Foundation)
        if: steps.check-ecr.outputs.setup_state == 'no_repo'
        run: terraform apply -auto-approve -target=aws_ecr_repository.app_repo

      # STEP B: Build and Push Docker image (If repo was just created or is empty)
      - name: Build & Push Docker Image
        if: steps.check-ecr.outputs.setup_state != 'ready'
        run: |
          docker build -t ${{ steps.aws-login.outputs.aws-account-id }}.dkr.ecr.us-east-1.amazonaws.com/app-repo:latest .
          docker push ${{ steps.aws-login.outputs.aws-account-id }}.dkr.ecr.us-east-1.amazonaws.com/app-repo:latest

      # STEP C: Now that an image DEFINITELY exists, run the full 21 resources
      - name: Terraform Apply (Full Stack)
        run: terraform apply -auto-approve
name: "Terraform Destroy"

on:
  workflow_dispatch: # This makes it a "Manual Button" only
    inputs:
      confirm_destroy:
        description: 'Type "DESTROY" to confirm'
        required: true

jobs:
  destroy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Terraform Destroy
        if: github.event.inputs.confirm_destroy == 'DESTROY'
        run: terraform destroy -auto-approve